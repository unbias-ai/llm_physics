#!/bin/sh
echo "ğŸ” Running mandatory pre-commit checks..."
echo ""

# 1. Lint
echo "1ï¸âƒ£  Linting..."
npm run lint || exit 1

# 2. Unit Tests
echo "2ï¸âƒ£  Running unit tests..."
npm test || exit 1

# 3. Coverage
echo "3ï¸âƒ£  Checking coverage..."
npm run test:coverage || exit 1

# 4. Validate Coverage Artifacts
echo "4ï¸âƒ£  Validating coverage artifacts..."
if [ ! -f coverage/lcov.info ]; then
  echo "âŒ ERROR: coverage/lcov.info not found"
  exit 1
fi

if [ ! -s coverage/lcov.info ]; then
  echo "âŒ ERROR: coverage/lcov.info is empty"
  exit 1
fi

FIRST_LINE=$(head -1 coverage/lcov.info)
if [[ "$FIRST_LINE" != TN:* ]] && [[ "$FIRST_LINE" != SF:* ]]; then
  echo "âŒ ERROR: lcov.info has invalid format"
  exit 1
fi

if [ ! -f coverage/coverage-summary.json ]; then
  echo "âŒ ERROR: coverage-summary.json not found"
  exit 1
fi

echo "âœ… Coverage artifacts valid"

# 5. Security Audit
echo "5ï¸âƒ£  Security audit (workflows)..."
if grep -r "pull_request.head" .github/workflows/ 2>/dev/null; then
  echo "âŒ ERROR: Untrusted PR checkout found"
  exit 1
fi
echo "âœ… No security issues"

# 6. Build
echo "6ï¸âƒ£  Building..."
npm run build || exit 1

echo ""
echo "âœ… All pre-commit checks passed!"
