name: Claude PR Review and Audit

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude_review:
    # Only run on PRs, not on issue comments unless they mention @claude
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        id: lint
        run: |
          echo "Running linter..."
          npm run lint
        continue-on-error: true

      - name: Run tests with coverage
        id: test
        run: |
          echo "Running tests with coverage..."
          npm run test -- --coverage --coverageReporters=json-summary --coverageReporters=text
        continue-on-error: true

      - name: Check test coverage threshold
        id: coverage
        run: |
          echo "Checking coverage threshold (95%)..."
          node -e "
          const fs = require('fs');
          try {
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            const percent = total.lines.pct;
            console.log(\`Coverage: \${percent}%\`);
            if (percent < 95) {
              console.log('Coverage below 95% threshold');
              process.exit(1);
            }
          } catch (e) {
            console.log('Coverage summary not found or invalid');
            process.exit(0);
          }
          "
        continue-on-error: true

      - name: Build Next.js
        id: build
        run: |
          echo "Building Next.js application..."
          npm run build
        continue-on-error: true

      - name: Run audit verification
        id: audit
        run: |
          echo "Running audit verification..."
          if [ -f "scripts/verify_audit_block.js" ]; then
            node scripts/verify_audit_block.js
          else
            echo "Audit script not found, skipping"
          fi
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Create audit log
        if: always()
        run: |
          mkdir -p artifacts/audit_logs
          cat > artifacts/audit_logs/pr-review-$(date +%Y%m%d-%H%M%S).json <<EOF
          {
            "timestamp": "$(date -Iseconds)",
            "pr_number": "${{ github.event.pull_request.number || 'N/A' }}",
            "commit": "${{ github.sha }}",
            "checks": {
              "lint": "${{ steps.lint.outcome }}",
              "test": "${{ steps.test.outcome }}",
              "coverage": "${{ steps.coverage.outcome }}",
              "build": "${{ steps.build.outcome }}",
              "audit": "${{ steps.audit.outcome }}"
            }
          }
          EOF

      - name: Upload audit log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-log-pr-review
          path: artifacts/audit_logs/
          retention-days: 90

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const lintResult = '${{ steps.lint.outcome }}';
            const testResult = '${{ steps.test.outcome }}';
            const coverageResult = '${{ steps.coverage.outcome }}';
            const buildResult = '${{ steps.build.outcome }}';
            const auditResult = '${{ steps.audit.outcome }}';

            const emoji = {
              'success': '✅',
              'failure': '❌',
              'skipped': '⏭️'
            };

            const body = `## Claude PR Review Results

            | Check | Status |
            |-------|--------|
            | Lint | ${emoji[lintResult] || '⚠️'} ${lintResult} |
            | Tests | ${emoji[testResult] || '⚠️'} ${testResult} |
            | Coverage (>95%) | ${emoji[coverageResult] || '⚠️'} ${coverageResult} |
            | Build | ${emoji[buildResult] || '⚠️'} ${buildResult} |
            | Audit | ${emoji[auditResult] || '⚠️'} ${auditResult} |

            **Commit:** ${context.sha.substring(0, 7)}
            **Workflow:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ---
            *Automated review by Claude Code orchestration system*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if critical checks failed
        if: |
          steps.lint.outcome == 'failure' ||
          steps.test.outcome == 'failure' ||
          steps.build.outcome == 'failure'
        run: |
          echo "Critical checks failed. Please fix the issues before merging."
          exit 1
