name: Claude Coverage Automation

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-coverage-check:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       (contains(github.event.comment.body, '/@claude check coverage') ||
        contains(github.event.comment.body, '/generate-tests')))

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Run coverage analysis
        run: npm run test:coverage
        continue-on-error: true

      - name: Generate coverage report
        id: coverage
        run: |
          echo "COVERAGE_REPORT<<EOF" >> $GITHUB_OUTPUT
          cat coverage/lcov.info | head -50 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post coverage summary
        if: github.event_name == 'pull_request' || github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageFile = 'coverage/coverage-summary.json';

            let summary = '## Coverage Analysis\n\n';

            if (fs.existsSync(coverageFile)) {
              const coverage = JSON.parse(fs.readFileSync(coverageFile, 'utf8'));
              const total = coverage.total;

              summary += `| Metric | Coverage | Status |\n`;
              summary += `|--------|----------|--------|\n`;

              const threshold = 80;
              const metrics = ['lines', 'statements', 'functions', 'branches'];

              metrics.forEach(metric => {
                const pct = total[metric].pct;
                const status = pct >= threshold ? 'âœ…' : 'âŒ';
                summary += `| ${metric} | ${pct}% | ${status} |\n`;
              });

              summary += `\n**Threshold**: ${threshold}%\n`;

              if (total.lines.pct < threshold) {
                summary += '\nâš ï¸ Coverage below threshold. Add tests before merge.\n';
              }
            } else {
              summary += 'âš ï¸ Coverage report not found. Tests may have failed.\n';
            }

            const issue_number = context.issue.number || context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: summary
            });

  claude-test-generation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/generate-tests')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Extract target path
        id: extract
        run: |
          COMMENT="${{ github.event.comment.body }}"
          PATH_ARG=$(echo "$COMMENT" | grep -oP '/generate-tests\s+\K\S+' || echo "")
          echo "target_path=$PATH_ARG" >> $GITHUB_OUTPUT

      - name: Comment on test generation start
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ”„ Analyzing code coverage and generating tests...'
            });
